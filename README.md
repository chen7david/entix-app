# **Entix-App**

Entix-App is a full-stack application built on **Cloudflare Workers** (API) and a **Vite + React** frontend (web).

- **Development**: Runs as two separate processes (Vite + Wrangler) for a fast developer experience.
- **Production**: Bundles into a **single Cloudflare Worker** that serves both the API and the static frontend assets.

---

## **Architecture**

### **Development Architecture**
In development, we run two separate servers. Vite proxies API requests to the Worker.

```mermaid
graph LR
    Dev[Developer] -->|http://localhost:8000| Vite[Vite Dev Server]
    Vite -->|/api/* (Proxy)| Worker[Cloudflare Worker (API)]
    Worker -->|Port 3000| Logic[API Logic]
```

### **Production Architecture**
In production, everything is deployed as a single unit. The Worker handles routing for both API endpoints and static files.

```mermaid
graph LR
    User[User] -->|https://entix.app| Worker[Cloudflare Worker]
    Worker -->|/api/*| Logic[API Logic]
    Worker -->|*| Assets[Static Assets (web/dist)]
```

---

## **Project Structure**

```
entix-app/
 ├── src/              # Worker API source code
 ├── web/              # Vite + React frontend
 ├── shared/           # Shared DTOs, schemas, utilities
 ├── wrangler.jsonc    # Cloudflare Worker config
 └── package.json      # Root package manager config
```

### **Shared Code**
The `shared` directory contains code used by **both** the API and the Web (e.g., Zod schemas, DTO types).
- Import via: `import { UserDTO } from "@shared";`
- No build step required; resolved automatically by `vite-tsconfig-paths` and Wrangler.

---

## **Development Workflow**

### **1. Setup**
Install dependencies for the root, API, and Web:

```bash
npm run dev:init
# Or manually:
# npm install && cd web && npm install
```

### **2. Run Locally**
Start both the API and Web servers concurrently:

```bash
npm run dev
```

- **Web**: [http://localhost:8000](http://localhost:8000)
- **API**: [http://localhost:3000](http://localhost:3000)

### **3. API Usage**
The frontend is configured to proxy `/api` requests to the backend. **Always use relative paths** in your frontend code:

```typescript
// ✅ Correct
const res = await axios.get("/api/v1/users");

// ❌ Incorrect (Don't hardcode localhost)
const res = await axios.get("http://localhost:3000/api/v1/users");
```

---

## **Deployment**

We use **Cloudflare Environments** to separate Staging and Production.

### **Staging (Preview)**
- **Trigger**: Automatic on every Pull Request.
- **Mechanism**: Cloudflare GitHub Integration builds and deploys a **Preview Worker**.
- **Environment**: Uses the `staging` environment in `wrangler.jsonc`.
- **Isolation**: Has separate D1 databases, KV namespaces, and R2 buckets from production.

### **Production**
- **Trigger**: Manual deployment.
- **Command**:
  ```bash
  npm run deploy
  ```
- **Mechanism**: Builds the frontend (`web/dist`) and deploys the Worker with assets to the `prod` environment.

### **Environment Configuration**
`wrangler.jsonc` defines the environments:

```jsonc
"env": {
  "staging": { ... }, // Uses preview databases/assets
  "prod": { ... }     // Uses production databases/assets
}
```

---

## **Error Handling & Validation**

The API uses a unified error handling strategy to ensure consistent responses.

### **Response Format**
All errors follow this JSON structure:

```json
{
  "success": false,
  "message": "Error description",
  "details": { ... }, // Optional validation details
  "status": 400
}
```

### **Validation**
We use **Zod** for request validation. Validation errors return a `422 Unprocessable Entity` status with detailed field errors.

```typescript
// Example: Validation Error Response
{
  "success": false,
  "message": "Validation failed",
  "details": {
    "email": ["Invalid email address"]
  },
  "status": 400
}
```

### **404 Handling**
Routes that do not exist return a standard 404 response generated by the central error handler.

---

## **Scripts Reference**

| Script | Description |
| :--- | :--- |
| `npm run dev` | Starts API and Web in development mode. |
| `npm run dev:init` | Installs all dependencies (Root + Web). |
| `npm run build:web` | Builds the React frontend to `web/dist`. |
| `npm run deploy` | Builds web and deploys to **Production**. |
| `npm run deploy:staging` | Builds web and deploys to **Staging** (manual trigger). |
